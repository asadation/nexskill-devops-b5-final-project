# CI workflow: builds docker-compose services and runs unit tests inside the service containers.
# - builds with no-cache to avoid using stale images (remove --no-cache if you want caching)
# - starts postgres and waits for it to become ready
# - runs unit tests with `npm run test --if-present` so missing test scripts won't hard-fail other services
# - tears down compose on completion
#
# Adjust services/test commands as needed for your repo.

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ci

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx (optional but recommended)
        uses: docker/setup-buildx-action@v2

      - name: Build docker-compose images (no cache)
        run: docker compose -f ./docker-compose.yml build --no-cache --parallel

      - name: Start required infrastructure (postgres)
        run: docker compose -f ./docker-compose.yml up -d postgres

      - name: Wait for Postgres to be ready
        run: |
          set -e
          RETRIES=60
          for i in $(seq 1 $RETRIES); do
            docker compose -f ./docker-compose.yml exec -T postgres pg_isready -U "${POSTGRES_USER:-postgres}" -d "${POSTGRES_DB:-urlshortener}" && { echo "Postgres ready"; exit 0; }
            echo "Waiting for Postgres ($i/$RETRIES)..."
            sleep 1
          done
          echo "Postgres did not become ready in time" >&2
          exit 1

      - name: Run analytics-service unit tests
        # Install deps (legacy peer deps option included to match your local usage) and run tests.
        run: |
          docker compose -f ./docker-compose.yml run --rm analytics-service sh -lc 'npm install --legacy-peer-deps --silent && npm run test --if-present -- --watchAll=false'

      - name: Run link-service unit tests (if present)
        if: always()
        run: |
          # If your link-service has tests, this will run them; if not, `--if-present` avoids failing.
          docker compose -f ./docker-compose.yml run --rm link-service sh -lc 'npm install --legacy-peer-deps --silent && npm run test --if-present -- --watchAll=false'

      - name: Bring down docker-compose (always)
        if: always()
        run: docker compose -f ./docker-compose.yml down --volumes --remove-orphans
