# CI: build images, start stack, run unit tests and e2e
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      COMPOSE_DOCKER_CLI_BUILD: 1
      DOCKER_BUILDKIT: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for cross-platform build, optional)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Optional: login to registry if you will push images (set DOCKERHUB_USERNAME and DOCKERHUB_TOKEN in repo secrets)
      - name: Login to DockerHub (optional)
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build docker-compose images
        run: docker compose build --parallel

      - name: Start stack
        run: docker compose up -d

      - name: Make wait-for-it executable
        run: chmod +x ./scripts/wait-for-it.sh

      - name: Wait for Postgres
        # wait-for-it checks TCP availability; adjust host/port if needed
        run: ./scripts/wait-for-it.sh -t 60 localhost:5432

      - name: Wait a short moment for other services
        run: sleep 5

      - name: Run unit tests (link-service)
        run: docker compose run --rm link-service sh -c "npm install --legacy-peer-deps && npm test -- --watchAll=false"

      - name: Run unit tests (analytics-service)
        run: docker compose run --rm analytics-service sh -c "npm install --legacy-peer-deps && npm test -- --watchAll=false"

      - name: Run frontend tests
        run: docker compose run --rm frontend sh -c "npm install --legacy-peer-deps && npm test -- --watchAll=false"

      - name: Run e2e tests
        run: docker compose run --rm e2e

      - name: Tear down docker-compose (always run)
        if: always()
        run: docker compose down --volumes --remove-orphans

